
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Render Fx - 1024x1024 Viewer</title>
    <!-- 1. Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. CSS Styling -->
    <style>
        /* Import the Inter font for a clean look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #f3f4f6;
            overflow: hidden; /* Hide scrollbars */
            margin: 0;
            padding: 0;
            position: relative; 
            height: 100vh;
            width: 100vw;
        }
        
        /* Hide the invisible source canvas */
        #sourceCanvas {
            display: none;
        }
        
        /* Wrapper to center the canvas */
        #canvasWrapper {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed; /* Keep it centered */
            top: 0;
            left: 0;
        }

        #pixelCanvas {
            width: 1024px;
            height: 1024px;
            max-width: 100vw;
            max-height: 100vh;
            background-color: #000;
            image-rendering: pixelated; 
            image-rendering: crisp-edges;
            z-index: 0; 
        }

        #canvasPlaceholder {
            position: absolute;
            z-index: 1; 
        }

        /* "Pop up jump" animation */
        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            60% {
                transform: scale(1.05); /* Overshoot */
                opacity: 1;
            }
            100% {
                transform: scale(1); /* Settle */
                opacity: 1;
            }
        }

        /* "Fade away" animation */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Apply popIn animation to overlay on load */
        #birthdayOverlay {
            animation: popIn 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        /* Utility class to trigger the fade-out animation */
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }

    </style>
</head>
<body>

    <!-- 3. HTML Structure: Birthday Overlay -->
    <div id="birthdayOverlay" class="fixed top-0 left-0 w-screen h-screen bg-black bg-opacity-95 flex flex-col items-center justify-center z-50">
        <h1 class="text-6xl font-bold text-white mb-8 text-center animate-pulse">
            Happy Birthday!
        </h1>
        <button id="birthdayButton" 
                class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-4 px-8 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-200 text-2xl">
            Click to Start
        </button>
    </div>

    <!-- 4. HTML Structure: The App Container (Still hidden by default) -->
    <!-- MODIFICATION: The Control Panel is now GONE. -->
    <div id="appContainer" class="hidden">
        <!-- Canvas Wrapper -->
        <div id="canvasWrapper">
            <!-- This is the placeholder text shown at the start -->
            <p id="canvasPlaceholder" class="text-gray-500 text-xl">
                Loading...
            </p>

            <!-- This is the visible canvas where the animation happens -->
            <canvas id="pixelCanvas"></canvas>
        </div>
    </div>

    <!-- This is an invisible canvas used to process the image -->
    <canvas id="sourceCanvas"></canvas>

    <!-- HTML5 Audio element for music.mp3 -->
    <audio id="birthdayAudio" src="./music.mp3" preload="auto"></audio>

    <!-- 5. JavaScript Logic -->
    <script>
        // --- Get DOM Elements ---
        
        // --- Birthday Screen Elements ---
        const birthdayOverlay = document.getElementById('birthdayOverlay');
        const birthdayButton = document.getElementById('birthdayButton');
        const appContainer = document.getElementById('appContainer');

        // App elements
        // MODIFICATION: Removed all control panel element getters
        
        const sourceCanvas = document.getElementById('sourceCanvas');
        const sourceCtx = sourceCanvas.getContext('2d');
        const pixelCanvas = document.getElementById('pixelCanvas');
        const pixelCtx = pixelCanvas.getContext('2d');
        
        const canvasPlaceholder = document.getElementById('canvasPlaceholder');

        // --- Get Audio Element ---
        const birthdayAudio = document.getElementById('birthdayAudio');

        // --- State Variables ---
        let originalImage = null; // Stores the loaded image object
        let flyingPixels = []; // Stores all pixel {x, y, color} objects
        let animationId = null; // Holds the ID for the animation loop
        
        // --- Animation Speed ---
        const EASING_FACTOR = 0.25; 

        // --- MODIFICATION: Removed all Gemini API variables ---

        
        // --- Animated Birthday Button Click Handler ---
        birthdayButton.addEventListener('click', () => {
            
            // 1. Unlock browser audio by playing and pausing it (muted)
            birthdayAudio.muted = true;
            birthdayAudio.play().then(() => {
                birthdayAudio.pause();
                birthdayAudio.muted = false;
                console.log("Audio context started.");
            }).catch(e => {
                console.warn("Audio unlock failed, will try again later.", e);
            });

            // 2. Add the fade-out class to start the animation
            birthdayOverlay.classList.add('fade-out');
            
            // 3. Listen for when the animation is complete
            birthdayOverlay.addEventListener('animationend', () => {
                // 4. Now, hide the overlay completely
                birthdayOverlay.classList.add('hidden');
                // 5. And show the main app
                appContainer.classList.remove('hidden');

                // 6. Load default sketch.jpg
                console.log("Loading default image: sketch.jpg");
                canvasPlaceholder.style.display = 'block';
                canvasPlaceholder.textContent = 'Loading sketch...';
                
                // This function will load the image AND start the animation/music
                loadImageFromSrc('./sketch.jpg'); 

            }, { once: true }); // {once: true} ensures this listener only runs once
        });

        // --- MODIFICATION: Removed all API and upload-related functions ---

        /**
         * Loads an image from a source (file, base64, or URL) into the app.
         */
        function loadImageFromSrc(imageSrc) {
            originalImage = new Image();
            originalImage.crossOrigin = "Anonymous"; 

            originalImage.onload = () => {
                
                if (originalImage.width !== 1024 || originalImage.height !== 1024) {
                    const warningMsg = `Warning: Image is ${originalImage.width}x${originalImage.height}. It will be scaled to 1024x1024.`;
                    console.warn(warningMsg);
                }

                canvasPlaceholder.style.display = 'none';
                
                // --- Start the show! ---
                renderImage();
            };
            originalImage.onerror = () => {
                console.error(`Failed to load image source: ${imageSrc}`);
                canvasPlaceholder.style.display = 'block';
                canvasPlaceholder.textContent = 'Error loading image. Make sure sketch.jpg is in the same folder.';
            };
            originalImage.src = imageSrc;
        }

        // --- MODIFICATION: Removed all event listeners for controls ---
      
        // --- Animation Logic ---
        
        /**
         * Main render function: Sets canvas to 1024x1024
         * and draws the image 1-to-1.
         */
        function renderImage() {
            if (!originalImage) return; 

            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // --- Logic is now fixed to 1024x1024 ---
            const canvasSize = 1024;
            
            pixelCanvas.width = canvasSize;
            pixelCanvas.height = canvasSize;
            sourceCanvas.width = canvasSize;
            sourceCanvas.height = canvasSize;

            sourceCtx.drawImage(
                originalImage, 
                0, 0, 
                originalImage.width, originalImage.height, 
                0, 0, 
                canvasSize, canvasSize 
            );

            generatePixelData(); 
            
            // --- Start music and animation together ---
            birthdayAudio.currentTime = 0; // Rewind the music
            birthdayAudio.play(); // Play the music
            
            animate(); // Start the pixel animation
        }

        /**
         * Samples the source canvas and populates the flyingPixels array.
         */
        function generatePixelData() {
            flyingPixels = []; 
            
            const size = 1;
            const w = sourceCanvas.width; 
            const h = sourceCanvas.height; 
            const canvasW = pixelCanvas.width; 
            const canvasH = pixelCanvas.height; 

            // --- Optimization: Get image data once ---
            const imageData = sourceCtx.getImageData(0, 0, w, h).data;

            for (let y = 0; y < h; y += size) { 
                for (let x = 0; x < w; x += size) { 
                    
                    const index = (y * w + x) * 4; // Calculate index in the 1D array
                    const r = imageData[index];
                    const g = imageData[index + 1];
                    const b = imageData[index + 2];
                    const a = imageData[index + 3];

                    if (a > 20) { // Only add pixels that are not fully transparent
                        flyingPixels.push({
                            endX: x, 
                            endY: y, 
                            startX: Math.random() * canvasW, 
                            startY: Math.random() * canvasH, 
                            currentX: Math.random() * canvasW, 
                            currentY: Math.random() * canvasH, 
                            color: `rgba(${r}, ${g}, ${b}, ${a / 255})`,
                            size: size 
                        });
                    }
                }
            }
        }

        /**
         * The main animation loop, runs ~60 times per second
         */
        function animate() {
            const w = pixelCanvas.width;
            const h = pixelCanvas.height;
            
            pixelCtx.clearRect(0, 0, w, h);
            
            let allPixelsInPlace = true; 

            for (const pixel of flyingPixels) {
                
                const dx = pixel.endX - pixel.currentX;
                const dy = pixel.endY - pixel.currentY;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist > 0.5) { // If pixel is not at its final spot
                    allPixelsInPlace = false; // Mark that animation is not done
                    
                    // Move pixel closer to its end position
                    pixel.currentX += dx * EASING_FACTOR;
                    pixel.currentY += dy * EASING_FACTOR;
                } else {
                    // Snap to final position
                    pixel.currentX = pixel.endX;
                    pixel.currentY = pixel.endY;
                }

                pixelCtx.fillStyle = pixel.color;
                pixelCtx.fillRect(pixel.currentX, pixel.currentY, pixel.size, pixel.size); 
            }

            if (!allPixelsInPlace) {
                // If animation is not done, request the next frame
                animationId = requestAnimationFrame(animate);
            } else {
                // Animation is complete
                animationId = null;
                console.log("Animation Complete!");
                
                // --- Stop music when animation finishes ---
                birthdayAudio.pause();
            }
        }

    </script>
</body>
</html>


